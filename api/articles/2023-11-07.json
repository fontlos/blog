{"title":"记一次 Rust 在 Windows 平台交叉编译 Android 时链接器报错的问题","uid":"2b7fe53c83778cdb6bbab88519dc8e10","slug":"2023-11-07","date":"2023-11-07T12:37:43.000Z","updated":"2024-03-06T02:36:48.103Z","comments":true,"path":"api/articles/2023-11-07.json","keywords":"Programming, Web, Frontend, Backend ,Rust, Blog, Aurora, Fontlos, 芳塔洛斯","cover":"https://fontlos.com/icons/logo.png","content":"<p>当尝试执行以下命令时</p>\n<div class=\"language-sh\"><button title=\"Copy code\" class=\"copy\"></button><span class=\"lang\">sh</span><pre class=\"shiki one-dark-pro\" style=\"background-color: #1a1a1a\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color: #61AFEF\">cargo</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #98C379\">build</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #D19A66\">--release</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #D19A66\">--target</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #98C379\">armv7-linux-androideabi</span></span></code></pre></div><p>输出了大量链接器错误, 如下</p>\n<div class=\"language-txt\"><button title=\"Copy code\" class=\"copy\"></button><span class=\"lang\">txt</span><pre class=\"shiki one-dark-pro\" style=\"background-color: #1a1a1a\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color: #abb2bf\">error: linking with `D:\\Programming\\Tool\\Android_SDK\\ndk\\26.1.10909125\\toolchains/llvm/prebuilt/windows-x86_64\\bin\\armv7a-linux-androideabi24-clang.cmd` failed: exit code: 255</span></span>\n<span class=\"line\"><span style=\"color: #abb2bf\">|</span></span>\n<span class=\"line\"><span style=\"color: #abb2bf\">= note: &quot;D:\\\\Programming\\\\Tool\\\\Android_SDK\\\\ndk\\\\26.1.10909125\\\\toolchains/llvm/prebuilt/windows-x86_64\\\\bin\\\\armv7a-linux-androideabi24-clang.cmd&quot; &quot;-march=armv7-a&quot; &quot;C:\\\\Users\\\\芳塔洛斯\\\\AppData\\\\Local\\\\Temp\\\\rustcXidorx\\\\symbols.o&quot; &quot;D:\\\\Programming\\\\Code\\\\Project\\\\Neno\\\\target\\\\armv7-linux-androideabi\\\\release\\\\deps\\\\neno_desktop-884e689b341ca3ff.neno_desktop.5bad0fe025bc0067-cgu.0.rcgu.o&quot; &quot;D:\\\\Programming\\\\Code\\\\Project\\\\Neno\\\\target\\\\armv7-linux-androideabi\\\\release\\\\deps\\\\neno_desktop-884e689b341ca3ff.160o3gui2v7nyyt0.rcgu.o&quot; &quot;-Wl,--as-needed&quot; &quot;-L&quot; &quot;D:\\\\Programming\\\\Code\\\\Project\\\\Neno\\\\target\\\\armv7-linux-androideabi\\\\release\\\\deps&quot; &quot;-L&quot; &quot;D:\\\\Programming\\\\Code\\\\Project\\\\Neno\\\\target\\\\release\\\\deps&quot; &quot;-L&quot; &quot;D:\\\\Programming\\\\Code\\\\Project\\\\Neno\\\\.cargo&quot; &quot;-L&quot; &quot;D:\\\\Programming\\\\Lang\\\\Rust\\\\rustup\\\\toolchains\\\\nightly-x86_64-pc-windows-msvc\\\\lib\\\\rustlib\\\\armv7-linux-androideabi\\\\lib&quot; &quot;-Wl,-Bstatic&quot; &quot;D:\\\\Programming\\\\Lang\\\\Rust\\\\rustup\\\\toolchains\\\\nightly-x86_64-pc-windows-msvc\\\\lib\\\\rustlib\\\\armv7-linux-androideabi\\\\lib\\\\libstd-8efdef55a48b6ede.rlib&quot; &quot;D:\\\\Programming\\\\Lang\\\\Rust\\\\rustup\\\\toolchains\\\\nightly-x86_64-pc-windows-msvc\\\\lib\\\\rustlib\\\\armv7-linux-androideabi\\\\lib\\\\libpanic_unwind-07cd329feb7291c7.rlib&quot; &quot;D:\\\\Programming\\\\Lang\\\\Rust\\\\rustup\\\\toolchains\\\\nightly-x86_64-pc-windows-msvc\\\\lib\\\\rustlib\\\\armv7-linux-androideabi\\\\lib\\\\libobject-6641e98bb52d50cc.rlib&quot; &quot;D:\\\\Programming\\\\Lang\\\\Rust\\\\rustup\\\\toolchains\\\\nightly-x86_64-pc-windows-msvc\\\\lib\\\\rustlib\\\\armv7-linux-androideabi\\\\lib\\\\libmemchr-2d91048f27d6b338.rlib&quot; &quot;D:\\\\Programming\\\\Lang\\\\Rust\\\\rustup\\\\toolchains\\\\nightly-x86_64-pc-windows-msvc\\\\lib\\\\rustlib\\\\armv7-linux-androideabi\\\\lib\\\\libaddr2line-084741aa5d6cd941.rlib&quot; &quot;D:\\\\Programming\\\\Lang\\\\Rust\\\\rustup\\\\toolchains\\\\nightly-x86_64-pc-windows-msvc\\\\lib\\\\rustlib\\\\armv7-linux-androideabi\\\\lib\\\\libgimli-2904fcb616c98a2a.rlib&quot; &quot;D:\\\\Programming\\\\Lang\\\\Rust\\\\rustup\\\\toolchains\\\\nightly-x86_64-pc-windows-msvc\\\\lib\\\\rustlib\\\\armv7-linux-androideabi\\\\lib\\\\librustc_demangle-1091b1d466e87f02.rlib&quot; &quot;D:\\\\Programming\\\\Lang\\\\Rust\\\\rustup\\\\toolchains\\\\nightly-x86_64-pc-windows-msvc\\\\lib\\\\rustlib\\\\armv7-linux-androideabi\\\\lib\\\\libstd_detect-babd879f83204512.rlib&quot; &quot;D:\\\\Programming\\\\Lang\\\\Rust\\\\rustup\\\\toolchains\\\\nightly-x86_64-pc-windows-msvc\\\\lib\\\\rustlib\\\\armv7-linux-androideabi\\\\lib\\\\libhashbrown-62f6523570fc14d7.rlib&quot; &quot;D:\\\\Programming\\\\Lang\\\\Rust\\\\rustup\\\\toolchains\\\\nightly-x86_64-pc-windows-msvc\\\\lib\\\\rustlib\\\\armv7-linux-androideabi\\\\lib\\\\librustc_std_workspace_alloc-fbf2621eda901e67.rlib&quot; &quot;D:\\\\Programming\\\\Lang\\\\Rust\\\\rustup\\\\toolchains\\\\nightly-x86_64-pc-windows-msvc\\\\lib\\\\rustlib\\\\armv7-linux-androideabi\\\\lib\\\\libminiz_oxide-5bcb0afe5fbf4dd6.rlib&quot; &quot;D:\\\\Programming\\\\Lang\\\\Rust\\\\rustup\\\\toolchains\\\\nightly-x86_64-pc-windows-msvc\\\\lib\\\\rustlib\\\\armv7-linux-androideabi\\\\lib\\\\libadler-a660143b5bd942ba.rlib&quot; &quot;D:\\\\Programming\\\\Lang\\\\Rust\\\\rustup\\\\toolchains\\\\nightly-x86_64-pc-windows-msvc\\\\lib\\\\rustlib\\\\armv7-linux-androideabi\\\\lib\\\\libunwind-943cfbb42cdd8649.rlib&quot; &quot;D:\\\\Programming\\\\Lang\\\\Rust\\\\rustup\\\\toolchains\\\\nightly-x86_64-pc-windows-msvc\\\\lib\\\\rustlib\\\\armv7-linux-androideabi\\\\lib\\\\libcfg_if-10240302b9880bbc.rlib&quot; &quot;D:\\\\Programming\\\\Lang\\\\Rust\\\\rustup\\\\toolchains\\\\nightly-x86_64-pc-windows-msvc\\\\lib\\\\rustlib\\\\armv7-linux-androideabi\\\\lib\\\\liblibc-c890c346954c3969.rlib&quot; &quot;D:\\\\Programming\\\\Lang\\\\Rust\\\\rustup\\\\toolchains\\\\nightly-x86_64-pc-windows-msvc\\\\lib\\\\rustlib\\\\armv7-linux-androideabi\\\\lib\\\\liballoc-4cf58211a4ab8478.rlib&quot; &quot;D:\\\\Programming\\\\Lang\\\\Rust\\\\rustup\\\\toolchains\\\\nightly-x86_64-pc-windows-msvc\\\\lib\\\\rustlib\\\\armv7-linux-androideabi\\\\lib\\\\librustc_std_workspace_core-203fca2270aba449.rlib&quot; &quot;D:\\\\Programming\\\\Lang\\\\Rust\\\\rustup\\\\toolchains\\\\nightly-x86_64-pc-windows-msvc\\\\lib\\\\rustlib\\\\armv7-linux-androideabi\\\\lib\\\\libcore-b05626a355470548.rlib&quot; &quot;D:\\\\Programming\\\\Lang\\\\Rust\\\\rustup\\\\toolchains\\\\nightly-x86_64-pc-windows-msvc\\\\lib\\\\rustlib\\\\armv7-linux-androideabi\\\\lib\\\\libcompiler_builtins-33cc9a2dc099b4f0.rlib&quot; &quot;-Wl,-Bdynamic&quot; &quot;-ldl&quot; &quot;-llog&quot; &quot;-lunwind&quot; &quot;-ldl&quot; &quot;-lm&quot; &quot;-lc&quot; &quot;-Wl,--eh-frame-hdr&quot; &quot;-Wl,-z,noexecstack&quot; &quot;-L&quot; &quot;D:\\\\Programming\\\\Lang\\\\Rust\\\\rustup\\\\toolchains\\\\nightly-x86_64-pc-windows-msvc\\\\lib\\\\rustlib\\\\armv7-linux-androideabi\\\\lib&quot; &quot;-o&quot; &quot;D:\\\\Programming\\\\Code\\\\Project\\\\Neno\\\\target\\\\armv7-linux-androideabi\\\\release\\\\deps\\\\neno_desktop-884e689b341ca3ff&quot; &quot;-Wl,--gc-sections&quot; &quot;-pie&quot; &quot;-Wl,-z,relro,-z,now&quot; &quot;-Wl,-O1&quot; &quot;-nodefaultlibs&quot; &quot;-landroid&quot; &quot;-llog&quot; &quot;-lOpenSLES&quot;</span></span>\n<span class=\"line\"><span style=\"color: #abb2bf\">= note: Non-UTF-8 output: \\xb4\\xcb\\xca\\xb1\\xb2\\xbb\\xd3\\xa6\\xd3\\xd0 =armv7-a\\&quot;\\&quot;\\xa1\\xa3\\r\\n</span></span>\n<span class=\"line\"><span style=\"color: #abb2bf\"></span></span>\n<span class=\"line\"><span style=\"color: #abb2bf\">error: could not compile `neno` (bin &quot;neno-desktop&quot;) due to previous error</span></span></code></pre></div><p>目前暂时的解决办法是找到对应的链接器, 比如这里是 <code>armv7a-linux-androideabi24-clang.cmd</code></p>\n<p>Bug 出现的位置是 <code>if &quot;%1&quot; == &quot;-cc1&quot; goto :L</code>, 将这一行替换为 <code>if &quot;%~1&quot; == &quot;-cc1&quot; goto :L</code> 即可</p>\n<p>Bug 出现的原因是 Rust 编译器传递的用于替换 <code>%1</code> 的参数 <code>-march=armv7-a</code> 以 <code>&quot;-march=armv7-a&quot;</code> 的形式传入, 原来的代码在传参后变成了 <code>if &quot;&quot;-march=armv7-a&quot;&quot; == &quot;-cc1&quot; goto :L</code>, 导致逻辑混乱</p>\n<p>这可能代表链接器无法接受一些特殊字符, 如 <code>% 、 、 、 ! ^ &quot;</code></p>\n<p>而 <code>%~1</code> 参数可以删除周围的 <code>&quot;</code> ,然后可以安全地解析它. 虽然不确定这是否可以作用于其他特殊字符</p>\n<p>该 Bug 在 Github上也有提及</p>\n<ul>\n<li><a href=\"https://github.com/rust-lang/rust/issues/113711\">When cross compiling Rust to Android on Windows, Rust 1.69.0+ can’t find the version script path. #113711</a></li>\n<li><a href=\"https://githubfast.com/android/ndk/issues/1856\">[BUG] clang.cmd doesn’t work well with -march&#x3D;armv7-a #1856</a></li>\n</ul>\n","feature":false,"text":"当尝试执行以下命令时 shcargo build --release --target armv7-linux-androideabi输出了大量链接器错误, 如...","permalink":"/post/2023-11-07","photos":[],"count_time":{"symbolsCount":"6.1k","symbolsTime":"6 mins."},"categories":[{"name":"Note","slug":"Note","count":9,"path":"api/categories/Note.json"}],"tags":[{"name":"Rust","slug":"Rust","count":12,"path":"api/tags/Rust.json"},{"name":"Android","slug":"Android","count":1,"path":"api/tags/Android.json"},{"name":"Resolution","slug":"Resolution","count":3,"path":"api/tags/Resolution.json"}],"toc":"","author":{"name":"芳塔洛斯","slug":"blog-author","avatar":"https://fontlos.com/icons/avatar.jpg","link":"/","description":"来人间一趟, 为散步一场<br />待走出岁月, 何样的彼方<br />才配得上这一路的颠沛与时光","socials":{"github":"https://github.com/fontlos","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{"bilibili":{"icon":"https://fontlos.com/icons/bilibili.svg","link":"https://space.bilibili.com/362772872"}}}},"mapped":true,"hidden":false,"prev_post":{"title":"记一次国家税务总局查验发票显示网络异常的解决方法","uid":"d0c31e3894b3e43582a292091995aba6","slug":"2023-12-11","date":"2023-12-11T12:37:43.000Z","updated":"2024-03-06T02:36:48.103Z","comments":true,"path":"api/articles/2023-12-11.json","keywords":"Programming, Web, Frontend, Backend ,Rust, Blog, Aurora, Fontlos, 芳塔洛斯","cover":"https://fontlos.com/icons/logo.png","text":"查验发票当然需要安装政府提供的证书, 安装完成后重启浏览器, 打开 税务总局官网, 但是这时我们导入发票后点击验证码仍然会显示网络异常, 此时打开控制台, 其中...","permalink":"/post/2023-12-11","photos":[],"count_time":{"symbolsCount":"1k","symbolsTime":"1 mins."},"categories":[{"name":"Note","slug":"Note","count":9,"path":"api/categories/Note.json"}],"tags":[{"name":"Resolution","slug":"Resolution","count":3,"path":"api/tags/Resolution.json"}],"author":{"name":"芳塔洛斯","slug":"blog-author","avatar":"https://fontlos.com/icons/avatar.jpg","link":"/","description":"来人间一趟, 为散步一场<br />待走出岁月, 何样的彼方<br />才配得上这一路的颠沛与时光","socials":{"github":"https://github.com/fontlos","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{"bilibili":{"icon":"https://fontlos.com/icons/bilibili.svg","link":"https://space.bilibili.com/362772872"}}}},"feature":false},"next_post":{"title":"基于 Hexo + Aurora + GitTalk 的博客项目, 并通过 Github Action 持续集成","uid":"6fd3072f35c36cdb6dca04682272855c","slug":"2023-08-30","date":"2023-08-30T02:33:17.000Z","updated":"2024-03-06T02:36:48.103Z","comments":true,"path":"api/articles/2023-08-30.json","keywords":"Programming, Web, Frontend, Backend ,Rust, Blog, Aurora, Fontlos, 芳塔洛斯","cover":"https://fontlos.com/icons/logo.png","text":"创建项目官方的教程 写的很清楚, 这里简单概括一下 建议使用 Yarn 或 Pnpm, 这里我采用 Pnpm 作为演示 首先安装全局 Hexo Cli 工具 s...","permalink":"/post/2023-08-30","photos":[],"count_time":{"symbolsCount":"6.4k","symbolsTime":"6 mins."},"categories":[{"name":"Note","slug":"Note","count":9,"path":"api/categories/Note.json"}],"tags":[{"name":"Frontend","slug":"Frontend","count":5,"path":"api/tags/Frontend.json"},{"name":"Hexo","slug":"Hexo","count":3,"path":"api/tags/Hexo.json"},{"name":"Web","slug":"Web","count":1,"path":"api/tags/Web.json"}],"author":{"name":"芳塔洛斯","slug":"blog-author","avatar":"https://fontlos.com/icons/avatar.jpg","link":"/","description":"来人间一趟, 为散步一场<br />待走出岁月, 何样的彼方<br />才配得上这一路的颠沛与时光","socials":{"github":"https://github.com/fontlos","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{"bilibili":{"icon":"https://fontlos.com/icons/bilibili.svg","link":"https://space.bilibili.com/362772872"}}}},"feature":false}}