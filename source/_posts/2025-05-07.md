---
feature: false
title: 使用 Claw 云容器改变自己的 IP (你懂的)
date: 2025-05-07 16:00:00
abstracts: Claw 似乎又称阿爪云, 好像因为是部署在阿里云上. 现在只要使用一个注册时间大于 180 天的 Github 用户登录就能每个月获取 5 美元的免费额度, 搭建一些轻量级小应用, 例如内网穿透, RustDesk 等绰绰有余了
tags:
    - Claw
    - Magic
categories:
    - Note
cover: https://fontlos.com/icons/logo.png
---
> **Warning**
>
> 本文所述网络代理技术仅限合法合规用途, 包括但不限于学术研究, 技术学习及网络安全测试. 笔者坚决拥护中国共产党的领导, 严格遵守《中华人民共和国网络安全法》《互联网信息服务管理办法》等法律法规, 反对任何利用技术手段破坏网络秩序, 侵犯他人隐私或绕过监管的违法行为. 所有技术讨论均以提升网络安全意识, 促进技术交流为目的, 读者须承诺遵守国家法律并承担因不当使用技术可能产生的一切法律责任. 特此声明.

之前的文章让大家领了 **Claw** 和 **Gemini**, 今天让我们来用一下, 用前者改变自己的 IP 来使用后者, 你懂的 :)

# 部署容器

首先我们在 Claw 中选择 **App Launchpad**, 创建一个应用. 应用名随便填. 然后我们需要一个轻量级的可以使用 Linux 命令的容器, 默认的镜像做不到, 所以我们换一个, 例如 `snowdreamtech/frps:0.59`, 配置方面, 0.5h0.25g 甚至更低即可, 我们不需要多大配置 (实测这个配置多数时候面板 CPU 占用 15% 左右, 内存占用 30% 左右, 所以还能压, 而且会更便宜)

在最下面储存卷那里, 随便挂在一个文件夹即可, 大小最小只能选那个 1g, 名字可以用默认的 `/data`

然后就是网络配置, 随便开放一个端口即可, 可以选的高位一点, 但是这样虽然比较隐秘, 但也特征明显. 协议类型选 UDP

除了储存卷, 配置大概这样

![image](./post/img/2025-05-07/1.png)

然后就可以点部署了. 如果显示端口已满, 那就是该地区的端口都分配完了, 我在使用 Japan 区域时就这样, 切换到 Germany 后可以部署, 代价可能是延迟会更高一点.

简单等待一会, 容器就部署好了

打开部署好的应用面板, 在网络那里, 可以看到我们自己开放的端口, 以及映射到的 UDP 链接, 注意这个 UDP 链接自己也有一个端口, 而且大概率和我们开放的端口不同

# 配置应用

打开部署好的应用面板, 在最下面可以看到有一个终端图标, 我们点击它

![image](./post/img/2025-05-07/2.jpeg)

经过一段执行, 最终会输出一行

```
sh: bash: not found
```

这是没有找到 `bash` 于是回退到 `sh` 终端, 也就是我们主要使用的终端, 但我们现在不使用它

## 获取公网 IP

当前窗口再新建一个终端, 这个终端将在根目录, 执行

```sh
curl -s ip.sb
```

这可以获取本机的公网 IP, 记住它, 然后关掉整个终端的窗口

## 安装应用

重新启动终端, 来到我们说的主要使用的终端

首先看一下我们的容器系统, 执行

```sh
cat /etc/os-release

# NAME="Alpine Linux"
# ID=alpine
# VERSION_ID=3.20.2
```

可以看到是一个很轻量级的 Alpine Linux, 然后安装我们的程序, 先进入挂载的储存卷, 例如我这里是 `/data`

```sh
cd data

# 根据系统安装即可
wget https://github.com/apernet/hysteria/releases/download/app%2Fv2.6.1/hysteria-linux-amd64

# 重命名方便后续操作
mv hysteria-linux-amd64 hy

# 赋予可执行权限

chmod +x hy
```

## 创建证书

简单的使用一个自签证书即可, 文件名随便即可

```sh
openssl genrsa -out <KEY>.key 2048
openssl req -new -x509 -key <KEY>.key -out <CERT>.crt -days 36000
```

## 服务端配置

然后使用自带的 VI 编辑器就够用了, 创建一个配置

```sh
vi s.yaml
```

输入以下配置

```yaml
listen: :<PORT>
speedTest: true
tls:
  cert: <CERT>.crt
  key: <KEY>.key
  sniGuard: disable
auth:
  type: password
  password: <PASSWORD>
```

注意, 这里的端口是配置应用时自己填的那个, 不是映射到 UDP 的那个

对于一般的使用, 这就足够了, 然后启用服务端

```sh
./hy server -c s.yaml
```

如果没发生报错, 则启动成功, 此时这个终端可以关掉了, 不会影响程序运行

## 客户端配置

然后我们给出对应的客户端配置, 只给出关键部分, 其他部分可以自己用 AI 生成或者抄其他的配置

```yaml
- name: <NAME>
  type: hysteria2
  server: <IP>
  port: <UDP PORT>
  password: <PASSWORD>
  skip-cert-verify: true
```

这里的 IP 是我们之前查的公网 IP, 端口是映射到 UDP 的端口

因为我们是自签证书所以需要跳过验证, 这可能会导致一些中间人攻击

# 进阶配置

如果你想进一步利用这个协议关于 SNI 的一些特点, 增强安全性, 并且有一个自主可控的域名, 可以继续看这些

这里我的域名托管在 Cloudflare 上, 新建一个看起来人畜无害的二级域名, 指向一个看起来人畜无害的地址, 比如 `0.0.0.0`, `1.1.1.1` 等, 我们将配置 **Certbot** 并使用 **Cloudflare DNS-01 质询** 来申请证书, 因此无需将域名解析到这个服务器上, 最大程度减少我们的域名与这个服务的关联, 避免被封域名.

## 安装应用

首先我们创建几个文件夹用于持久化配置, 防止容器重启后配置消失

```sh
mkdir -p /data/letsencrypt_config
mkdir -p /data/cloudflare_secrets
```

因为 Certbot 依赖 Python, 所以我们先安装一个 Python 环境, 反正分配 1g 存储不用白不用 (这暂时不起作用)

```sh
wget https://github.com/astral-sh/python-build-standalone/releases/download/20250409/cpython-3.12.10+20250409-x86_64-unknown-linux-musl-install_only.tar.gz -O /tmp/python_install.tar.gz
# 这将解压到 /data/python
tar -xzf /tmp/python_install.tar.gz -C /data
```

然后创建一个虚拟环境并安装 Certbot

```sh
/data/python/bin/python3 -m venv /data/certbot_venv

# 更新 pip, 可选
/data/certbot_venv/bin/pip install --upgrade pip

/data/certbot_venv/bin/pip install certbot certbot-dns-cloudflare
```

当然如果你不嫌每次重启都需要重装 Python 环境和 Certbot, 对于我们的 Alpine Linux 可以直接

```sh
apk update
apk upgrade
apk add certbot certbot-dns-cloudflare
```

反正能持久化配置文件才更重要, 安装程序并不复杂, 而且这样还能防止某些包失效, 可能更方便一点

## 获取 Cloudflare Token

因为需要通过 DNS TXT 记录质询来申请证书, 需要获取一个 Cloudflare Token, 登录自己的账户, 右上角选配置文件, 然后左边选项卡找到 **API Token**, 创建一个新的, 模板选择 **编辑 DNS**, 这个权限就足够了, 然后创建, 复制这个 Token, 写入配置文件

```sh
vi /data/cloudflare_secrets/cloudflare.ini

# 填入
# dns_cloudflare_api_token = YOUR_CLOUDFLARE_API_TOKEN_HERE
# :wq 退出

# 修改权限
chmod 0400 /data/cloudflare_secrets/cloudflare.ini
chown root:root /data/cloudflare_secrets/cloudflare.ini
```

## 获取证书

接下来的命令比较长, 好在每一个参数基本都能从字面看懂

```sh
certbot certonly \
    --config-dir /data/letsencrypt_config \
    --work-dir /data/letsencrypt_config/work \
    --logs-dir /data/letsencrypt_config/logs \
    --dns-cloudflare \
    --dns-cloudflare-credentials /data/cloudflare_secrets/cloudflare.ini \
    --dns-cloudflare-propagation-seconds 30 \
    -d <YOUR DOMAIN> \
    --agree-tos \
    --email <YOUR EMAIL> \
    --no-eff-email
```

其中第二行是最重要的参数, 储存了关键配置信息, 参数 `30` 是留给 Cloudflare DNS 生效的响应时间, 这通常很快, 30 秒足以, 不放心可以设置成 60. 如果没发生任何报错, 那么证书就申请成功了

检查更新证书是否正常工作

```sh
certbot renew \
    --config-dir /data/letsencrypt_config \
    --work-dir /data/letsencrypt_config/work \
    --logs-dir /data/letsencrypt_config/logs \
    --dry-run
```

## 更新配置

最后我们修改一下我们的配置, 启用我们的域名, 将 `sniGuard` 设为 `strict`, 只有域名匹配才能握手成功. 这里只给出需要修改的字段

```yaml
cert: /data/letsencrypt_config/live/<YOUR DOMIAN>/fullchain.pem
key: /data/letsencrypt_config/live/<YOUR DOMIAN>/privkey.pem
sniGuard: strict
```

然后重新启动服务端, 并修改客户端

```yaml
sni: <YOUR DOMAIN>
skip-cert-verify: false
```
