---
feature: false
title: 300 KB 的小工具关闭 Windows Defender
date: 2025-06-08 12:00:00
abstracts: 一个 300 KB 的小工具, 通过 DLL 注入注册 Anti Virus 程序, 以通知 Windows 安全中心服务关闭 Windows Defender
tags:
    - Windows
    - Rust
    - Tool
categories:
    - Share
cover: https://fontlos.com/icons/logo.png
---

# 简单介绍

嗨, 搓了一个小工具 -- **Defender-rs**, 用以关闭烦人的 Windows Defender. 在良好的电脑使用习惯加持下, 这东西对用户只有负提升, 经常乱删我自己编译的二进制文件, 而且频繁的扫描也会拖慢电脑性能, 因此有了这个项目

项目地址 [fontlos/defender-rs](https://github.com/fontlos/defender-rs) 灵感来源于 [es3n1n/defendnot](https://github.com/es3n1n/defendnot). 作为学习项目采用 **Rust** 实现 (因为只有 `windows-rs` 这一个依赖, 体积来到了惊人的 300 KB 左右)

> **允许使用须知**
>
> 严禁使用此工具来促进恶意软件分发, 网络犯罪, 未经授权的访问, 逃避检测或任何非法活动
> 用户对他们如何使用此工具及其任何后果承担所有法律责任. 使用此工具时, 您必须遵守所有适用的地方法律
> 下载, 安装或使用此工具, 即表示您承认您已阅读, 理解并同意这些条款

# 工作原理

**Windows 安全中心 (WSC)** 允许第三方 AV/AS 自行注册. 当 Defender 检测到另一个已注册的 AV/AS 时, 它会禁用自身. `defender-rs` 通过 COM 与 WSC 通信, 通过 DLL 注入将注册代码植入任务管理器这种高权限受信任的程序, 执行注册自定义 AV/AS 产品, 以便 Defender 进入 "受保护" 状态, 从而自行退出, 效果如下图所示

![image](./post/img/2025-06-08.png)

# 安装和使用

1. 下载最新的 [release](https://github.com/fontlos/defender-rs/releases/latest)
2. 解压并以管理员权限运行 `defender.exe`, 在命令行只需
   ```sh
   sudo defender.exe
   ```
3. 命令行使用: 默认执行会设置 AV 程序名称, 执行 DLL 注入并注册 AV 程序, 同时在 **任务计划程序** 中设定一个自动任务以便每次开机时自动执行, 因此使用期间 **不能删除此程序**
   ```shell
   Usage: defender.exe [--name <NAME>] [--disable] [--auto] [--on-login]

   Options:
     --name         设置 AV 程序名称 (默认: Defender-rs)
     --disable      注销本程序并删除自动任务
     --auto         静默模式 (无窗口, 用于自动启动时执行)
     --on-login     自动任务模式, 开机时启动 or 登录时启动 (默认开机时启动)
   ```

# 使用限制

- 如上面所说, 使用本程序时您不能删除它, 必须将两个二进制文件保留在硬盘上, 尽管这只有 300 KB, 似乎仍然不够优雅, 但暂时没有更好的办法了
- 无法在 Windows Server 上使用, 因为它没有 Windows 安全中心服务
- 因为我们的程序功能是通过 DLL 注入行为关闭 Windows Defender, 所以必定会报毒, 代码开源, 可以审阅, 无任何恶意行为. 因此初次使用时需要手动暂时关闭防病毒功能, 或者在本程序被 Windows Defender 删除时在 **保护的历史记录** 中恢复本程序, 这样就可以让 Windows Server 不再针对本程序

# 合法用途

- 学习研究 Windows 安全机制
- 在日常使用或开发软件时关闭 Windows Server 以减少占用并防止 Windows Server 乱删文件
- **再次强调, 严禁用于违法行为**

# 再次致谢

- [es3n1n](https://github.com/es3n1n) 的原型实现与逆向工程
- [mrbruh](https://mrbruh.com) 的逆向工程与测试
- [pindos](https://github.com/pind0s) 的 WSC 调试
